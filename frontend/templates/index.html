{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1>
            <i class="fas fa-chart-line me-2"></i>
            STOCK FACTOR ANALYSIS
        </h1>
        <p>Analyze factor exposures, correlation anomalies, and macro event impacts</p>
    </div>
    <div class="card-body">
        <div class="row mb-5">
            <div class="col-lg-8">
                <h3>
                    <i class="fas fa-play-circle me-2"></i>
                    RUN ANALYSIS
                </h3>
                <form id="analysisForm" class="row g-4 mt-3">
                    <div class="col-md-6">
                        <label for="tickerSelect" class="form-label">
                            <i class="fas fa-list me-2"></i>SELECT STOCK(S)
                        </label>
                        <select class="form-select" id="tickerSelect" multiple size="6" required>
                            <option value="AAPL">AAPL - Apple Inc.</option>
                            <option value="MSFT">MSFT - Microsoft Corporation</option>
                            <option value="GOOGL">GOOGL - Alphabet Inc.</option>
                            <option value="AMZN">AMZN - Amazon.com Inc.</option>
                            <option value="TSLA">TSLA - Tesla Inc.</option>
                            <option value="META">META - Meta Platforms Inc.</option>
                            <option value="NVDA">NVDA - NVIDIA Corporation</option>
                            <option value="SPY">SPY - SPDR S&P 500 ETF</option>
                            <option value="QQQ">QQQ - Invesco QQQ Trust</option>
                            <option value="TLT">TLT - iShares 20+ Year Treasury Bond ETF</option>
                            <option value="GLD">GLD - SPDR Gold Trust</option>
                            <option value="DXY">DXY - US Dollar Index</option>
                        </select>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Hold Ctrl/Cmd to select multiple stocks
                        </small>
                    </div>
                    <div class="col-md-3">
                        <label for="startDate" class="form-label">
                            <i class="fas fa-calendar-alt me-2"></i>START DATE
                        </label>
                        <input type="date" class="form-control" id="startDate" value="2023-01-01" required>
                    </div>
                    <div class="col-md-3">
                        <label for="endDate" class="form-label">
                            <i class="fas fa-calendar-check me-2"></i>END DATE
                        </label>
                        <input type="date" class="form-control" id="endDate" value="{{ today }}" required>
                    </div>
                    <div class="col-12">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="fitSABR" checked>
                            <label class="form-check-label" for="fitSABR">
                                <i class="fas fa-chart-area me-2"></i>
                                Include SABR volatility analysis (options data)
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-rocket me-2"></i>
                            EXECUTE ANALYSIS
                        </button>
                        <span class="loading ms-3" id="loadingSpinner">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>PROCESSING...</span>
                        </span>
                    </div>
                </form>
            </div>
            <div class="col-lg-4">
                <div class="stat-card">
                    <div class="stat-value">{{ report_count }}</div>
                    <div class="stat-label">
                        <i class="fas fa-file-alt me-2"></i>
                        TOTAL REPORTS
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="my-5">
        
        <h3>
            <i class="fas fa-file-alt me-2"></i>
            RECENT REPORTS
        </h3>
        
        {% if reports %}
        <div id="reportsList" class="mt-4">
            {% for report in reports %}
            <div class="report-item" onclick="window.location.href='/report/{{ report.filename }}'">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <a href="/report/{{ report.filename }}" class="report-link" onclick="event.stopPropagation()">
                            <i class="fas fa-chart-bar me-2"></i>
                            {{ report.ticker }}_ANALYSIS
                        </a>
                        <div class="report-meta mt-2">
                            <i class="fas fa-calendar me-1"></i>
                            {{ report.date_str }}
                            <span class="ms-3">
                                <i class="fas fa-tags me-1"></i>
                                {{ report.sections|length }} SECTIONS
                            </span>
                        </div>
                    </div>
                    <div>
                        <span class="badge">{{ report.ticker }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h4 class="mt-3" style="color: var(--text-secondary);">NO REPORTS FOUND</h4>
            <p class="text-muted">Run an analysis to generate your first report</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Input sanitization
function sanitizeInput(input) {
    return input.replace(/[<>]/g, '');
}

// Set today's date as default
document.getElementById('endDate').value = new Date().toISOString().split('T')[0];

document.getElementById('analysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const tickers = Array.from(document.getElementById('tickerSelect').selectedOptions)
        .map(option => sanitizeInput(option.value));
    
    if (tickers.length === 0) {
        alert('ERROR: Please select at least one stock');
        return;
    }
    
    // Validate ticker format
    const tickerPattern = /^[A-Z0-9]+$/;
    for (const ticker of tickers) {
        if (!tickerPattern.test(ticker)) {
            alert('ERROR: Invalid ticker format: ' + ticker);
            return;
        }
    }
    
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const fitSABR = document.getElementById('fitSABR').checked;
    
    // Validate dates
    if (new Date(startDate) > new Date(endDate)) {
        alert('ERROR: Start date must be before end date');
        return;
    }
    
    const loadingSpinner = document.getElementById('loadingSpinner');
    const submitBtn = e.target.querySelector('button[type="submit"]');
    
    loadingSpinner.classList.add('show');
    submitBtn.disabled = true;
    
    try {
        const response = await fetch('/api/run-analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tickers: tickers,
                start_date: startDate,
                end_date: endDate,
                fit_sabr: fitSABR
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(`âœ“ ANALYSIS INITIATED FOR ${tickers.join(', ').toUpperCase()}\n\nPage will refresh in 5 seconds...`);
            setTimeout(() => location.reload(), 5000);
        } else {
            alert('ERROR: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('ERROR: ' + error.message);
    } finally {
        loadingSpinner.classList.remove('show');
        submitBtn.disabled = false;
    }
});
</script>
{% endblock %}
