<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equity Factor Analysis</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #F8FAFC;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #0EA5E9;
            /* Sky-500 */
            margin-top: -6px;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }

        select {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #F8FAFC;
        }
    </style>
</head>

<body class="h-screen overflow-hidden flex">
    <div id="root" class="w-full h-full flex"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- COMPONENTS ---

        function MetricCard({ label, value, delta, subtext, tooltip }) {
            const isPos = delta > 0;
            const color = isPos ? 'text-emerald-400' : (delta < 0 ? 'text-rose-400' : 'text-slate-400');
            const sign = isPos ? '+' : '';

            return (
                <div className="glass p-5 rounded-xl flex flex-col justify-between hover:border-slate-500 transition-colors duration-300 relative group">
                    <div className="text-slate-400 text-sm font-medium tracking-wide uppercase flex items-center">
                        {label}
                        {tooltip && (
                            <span className="ml-1 text-slate-500 cursor-help" title={tooltip}>‚ìò</span>
                        )}
                    </div>
                    <div className="text-3xl font-bold text-white mt-1">{value}</div>
                    <div className={`text-sm mt-3 font-mono flex items-center ${color}`}>
                        {delta !== null && delta !== 0 && <span className="mr-1">{sign}{delta}</span>}
                        {subtext && <span className="text-slate-500 ml-2 text-xs">{subtext}</span>}
                    </div>
                    {tooltip && (
                        <div className="absolute bottom-full left-0 mb-2 hidden group-hover:block z-10 w-64 p-2 text-xs text-slate-300 bg-slate-900 border border-slate-700 rounded shadow-lg">
                            {tooltip}
                        </div>
                    )}
                </div>
            );
        }

        function DataTable({ title, data, columns, explanation }) {
            return (
                <div className="glass p-6 rounded-xl">
                    <h3 className="text-lg font-semibold text-white mb-2">{title}</h3>

                    {explanation && (
                        <div className="bg-slate-800/50 rounded-lg p-3 mb-4 text-xs text-slate-400 leading-relaxed">
                            {typeof explanation === 'string' ? explanation : explanation}
                        </div>
                    )}

                    {(!data || data.length === 0) ? (
                        <p className="text-slate-400 text-sm">No data available</p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="border-b border-slate-700">
                                        {columns.map(col => (
                                            <th key={col} className="text-left py-3 px-4 text-slate-400 font-semibold uppercase text-xs">{col}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.map((row, idx) => (
                                        <tr key={idx} className="border-b border-slate-800 hover:bg-slate-800/50 transition-colors">
                                            {columns.map(col => (
                                                <td key={col} className="py-3 px-4 text-slate-300 font-mono">
                                                    {typeof row[col] === 'number' ? row[col].toFixed(3) : row[col]}
                                                </td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }

        function ChartCard({ title, subtitle, chartRef, height = "400px", hasData = false }) {
            return (
                <div className="glass rounded-2xl p-6 relative flex flex-col min-h-0">
                    <div className="mb-4">
                        <h2 className="text-lg font-semibold text-white">{title}</h2>
                        {subtitle && <p className="text-slate-400 text-sm mt-1">{subtitle}</p>}
                    </div>
                    <div className="flex-1 relative" style={{ height }}>
                        <canvas ref={chartRef}></canvas>
                        {!hasData && (
                            <div className="absolute inset-0 flex items-center justify-center text-slate-500 text-sm bg-slate-900/50">
                                Run analysis to see chart
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---

        function App() {
            const [loading, setLoading] = useState(false);
            const [ticker, setTicker] = useState("AAPL");
            const today = new Date().toISOString().split('T')[0];
            const minDate = "2000-01-01";
            const [startDate, setStartDate] = useState("2023-01-01");
            const [endDate, setEndDate] = useState(today);
            const [fitSABR, setFitSABR] = useState(true);
            const [results, setResults] = useState(null);
            const [error, setError] = useState(null);
            const [chartInstances, setChartInstances] = useState({});

            const factorChartRef = useRef(null);
            const correlationChartRef = useRef(null);

            const tickerOptions = [
                { value: "AAPL", label: "AAPL - Apple Inc." },
                { value: "MSFT", label: "MSFT - Microsoft" },
                { value: "GOOGL", label: "GOOGL - Alphabet" },
                { value: "AMZN", label: "AMZN - Amazon" },
                { value: "TSLA", label: "TSLA - Tesla" },
                { value: "META", label: "META - Meta" },
                { value: "NVDA", label: "NVDA - NVIDIA" },
                { value: "SPY", label: "SPY - S&P 500 ETF" },
                { value: "QQQ", label: "QQQ - QQQ Trust" },
                { value: "TLT", label: "TLT - Treasury Bond ETF" },
                { value: "GLD", label: "GLD - Gold Trust" }
            ];

            const runAnalysis = async () => {
                setLoading(true);
                setError(null);
                setResults(null);

                // Validate dates
                if (startDate < minDate) {
                    setError(`Start date cannot be before ${minDate}`);
                    setLoading(false);
                    return;
                }
                if (endDate > today) {
                    setError('End date cannot be in the future');
                    setLoading(false);
                    return;
                }
                if (startDate > endDate) {
                    setError('Start date must be before end date');
                    setLoading(false);
                    return;
                }

                try {
                    const response = await fetch('/api/run-analysis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            tickers: [ticker],
                            start_date: startDate,
                            end_date: endDate,
                            fit_sabr: fitSABR
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Analysis failed');
                    }

                    // Poll for results (since analysis runs in background)
                    let pollCount = 0;
                    const maxPolls = 30; // 60 seconds total (2s * 30)

                    const pollInterval = setInterval(async () => {
                        pollCount++;
                        try {
                            // Get parsed results from API
                            const resultsResponse = await fetch(`/api/analysis-results/${ticker}`);
                            if (resultsResponse.ok) {
                                const resultsData = await resultsResponse.json();

                                setResults({
                                    ticker: ticker,
                                    r_squared: resultsData.r_squared || 0,
                                    factors: resultsData.factors || [],
                                    anomalies: resultsData.anomalies || 0,
                                    anomalies_data: resultsData.anomalies_data || [],
                                    events: resultsData.events || 0,
                                    events_data: resultsData.events_data || [],
                                    sabr: resultsData.sabr || null
                                });

                                clearInterval(pollInterval);
                                setLoading(false);
                                return;
                            }
                        } catch (err) {
                            // Report might not exist yet, continue polling
                            if (err.message && !err.message.includes('404')) {
                                console.error('Polling error:', err);
                            }
                        }

                        // Timeout after max polls
                        if (pollCount >= maxPolls) {
                            clearInterval(pollInterval);
                            setError('Analysis is taking longer than expected. Results will appear when ready.');
                            setLoading(false);
                        }
                    }, 2000);

                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            // Render factor chart
            useEffect(() => {
                if (!results || !factorChartRef.current || !results.factors || results.factors.length === 0) {
                    // Clear chart if no data
                    if (chartInstances.factor) {
                        chartInstances.factor.destroy();
                        setChartInstances(prev => ({ ...prev, factor: null }));
                    }
                    return;
                }

                const ctx = factorChartRef.current.getContext('2d');

                // Destroy existing chart
                if (chartInstances.factor) {
                    chartInstances.factor.destroy();
                }

                // Use actual factor data from results
                const factors = results.factors.map(f => f.Factor);
                const betas = results.factors.map(f => f.Beta);

                const newChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: factors,
                        datasets: [{
                            label: 'Beta',
                            data: betas,
                            backgroundColor: betas.map(b => b >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)'),
                            borderColor: betas.map(b => b >= 0 ? '#10B981' : '#EF4444'),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                titleColor: '#F8FAFC',
                                bodyColor: '#E2E8F0',
                                borderColor: '#334155',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    title: function (context) {
                                        const factor = results.factors[context[0].dataIndex];
                                        const factorDescriptions = {
                                            'Market': 'Market Factor (vs S&P 500)',
                                            'Value': 'Value Factor (High B/M vs Low B/M)',
                                            'Size': 'Size Factor (Small Cap vs Large Cap)',
                                            'Momentum': 'Momentum Factor (Winners vs Losers)'
                                        };
                                        return factorDescriptions[factor.Factor] || factor.Factor;
                                    },
                                    label: function (context) {
                                        const factor = results.factors[context.dataIndex];
                                        return [
                                            `Beta: ${factor.Beta.toFixed(4)}`,
                                            `t-statistic: ${factor['t-stat'].toFixed(2)}`,
                                            `p-value: ${factor['p-value'].toFixed(4)}`,
                                            '',
                                            factor.Beta > 0 ? '‚Üë Moves WITH this factor' : '‚Üì Moves AGAINST this factor',
                                            Math.abs(factor['t-stat']) > 2 ? '‚òÖ Statistically significant' : '‚óã Not statistically significant'
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#1E293B' },
                                ticks: { color: '#64748B' }
                            },
                            y: {
                                grid: { display: false },
                                ticks: { color: '#64748B' }
                            }
                        }
                    }
                });

                setChartInstances(prev => ({ ...prev, factor: newChart }));
            }, [results]);

            return (
                <div className="flex w-full h-full bg-[#0F172A]">
                    {/* SIDEBAR */}
                    <div className="w-80 glass-panel p-6 flex flex-col shrink-0 overflow-y-auto">
                        <div className="mb-8">
                            <h1 className="text-lg font-semibold tracking-tight text-slate-300">Equity Factor Analysis</h1>
                        </div>

                        <div className="mb-6">
                            <label className="block text-slate-400 text-sm font-medium mb-2">Stock</label>
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={ticker}
                                    onChange={(e) => setTicker(e.target.value.toUpperCase())}
                                    placeholder="Enter ticker (e.g., AAPL)"
                                    className="flex-1 p-3 rounded-lg bg-slate-800 border border-slate-700 text-white placeholder-slate-500 uppercase"
                                    maxLength={10}
                                />
                            </div>
                            <div className="mt-2 flex flex-wrap gap-1">
                                {["AAPL", "MSFT", "GOOGL", "TSLA", "SPY", "QQQ"].map(t => (
                                    <button
                                        key={t}
                                        onClick={() => setTicker(t)}
                                        className={`px-2 py-1 text-xs rounded ${ticker === t ? 'bg-sky-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                                    >
                                        {t}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="mb-6">
                            <label className="block text-slate-400 text-sm font-medium mb-2">Start Date</label>
                            <input
                                type="date"
                                value={startDate}
                                min={minDate}
                                max={today}
                                onChange={(e) => {
                                    const newDate = e.target.value;
                                    if (newDate >= minDate && newDate <= today) {
                                        setStartDate(newDate);
                                    }
                                }}
                                className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 text-white"
                            />
                        </div>

                        <div className="mb-6">
                            <label className="block text-slate-400 text-sm font-medium mb-2">End Date</label>
                            <input
                                type="date"
                                value={endDate}
                                min={minDate}
                                max={today}
                                onChange={(e) => {
                                    const newDate = e.target.value;
                                    if (newDate >= minDate && newDate <= today) {
                                        setEndDate(newDate);
                                    }
                                }}
                                className="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 text-white"
                            />
                        </div>

                        {/* Date Notes */}
                        <div className="mb-6 p-3 bg-slate-800/50 rounded-lg text-xs text-slate-500">
                            <p className="font-medium text-slate-400 mb-1">üìÖ Date Notes:</p>
                            <ul className="space-y-1">
                                <li>‚Ä¢ Valid range: 2000-01-01 to today</li>
                                <li>‚Ä¢ Max span: 5 years per analysis</li>
                                <li>‚Ä¢ Longer ranges = better correlation stats</li>
                                <li>‚Ä¢ 1+ year recommended for factor analysis</li>
                            </ul>
                        </div>

                        <div className="mb-6">
                            <label className="flex items-center space-x-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={fitSABR}
                                    onChange={(e) => setFitSABR(e.target.checked)}
                                    className="w-4 h-4 rounded bg-slate-800 border-slate-700"
                                />
                                <span className="text-slate-300 text-sm">Include SABR Analysis</span>
                            </label>
                        </div>

                        <button
                            onClick={runAnalysis}
                            disabled={loading}
                            className="w-full py-3 px-4 bg-sky-500 hover:bg-sky-600 text-white font-medium rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-sky-700 shadow-lg shadow-sky-500/20"
                        >
                            {loading ? 'Processing...' : 'Execute Analysis'}
                        </button>

                        {error && (
                            <div className="mt-4 p-3 bg-rose-900/30 border border-rose-700 rounded-lg text-rose-300 text-sm">
                                {error}
                            </div>
                        )}

                        <div className="mt-auto pt-6">
                            <div className="p-4 rounded-lg bg-slate-900 border border-slate-800 text-xs text-slate-500">
                                Equity Factor Radar
                            </div>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 flex flex-col p-8 overflow-y-auto">
                        {!results && !loading && (
                            <div className="flex-1 flex items-center justify-center">
                                <div className="text-center">
                                    <h2 className="text-xl font-semibold text-slate-300 mb-2">Equity Factor Radar</h2>
                                    <p className="text-slate-500 text-sm">Configure settings and run analysis to begin</p>
                                </div>
                            </div>
                        )}

                        {loading && (
                            <div className="flex-1 flex items-center justify-center">
                                <div className="text-center">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"></div>
                                    <p className="text-slate-400">Running analysis...</p>
                                </div>
                            </div>
                        )}

                        {results && (
                            <>
                                {/* HEADER METRICS */}
                                <div className="grid grid-cols-4 gap-6 mb-8">
                                    <MetricCard
                                        label="Ticker"
                                        value={results.ticker}
                                        tooltip="The stock symbol being analyzed"
                                    />
                                    <MetricCard
                                        label="R¬≤ (Fit Quality)"
                                        value={results.r_squared ? results.r_squared.toFixed(3) : "0.000"}
                                        tooltip="How much of the stock's movement is explained by our 4 factors. 1.0 means perfect explanation, 0.0 means none. Typical stocks are between 0.05 and 0.20."
                                    />
                                    <MetricCard
                                        label="Anomalies"
                                        value={String(results.anomalies || 0)}
                                        tooltip="Unusual days when the stock's relationship with other assets (like Gold or Bonds) broke down or became much stronger than normal."
                                    />
                                    <MetricCard
                                        label="Macro Events"
                                        value={String(results.events || 0)}
                                        tooltip="Major economic news releases (like inflation or job data) that happened during your analysis period."
                                    />
                                </div>

                                {/* FACTOR EXPOSURES */}
                                <div className="mb-8">
                                    <div className="glass rounded-2xl p-6">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <h2 className="text-lg font-semibold text-white">Factor Exposures</h2>
                                                <p className="text-slate-400 text-sm mt-1">
                                                    Beta coefficients from OLS regression of stock returns against factor returns
                                                </p>
                                            </div>
                                            <div className="text-right text-xs text-slate-500">
                                                <p>Hover bars for details</p>
                                            </div>
                                        </div>

                                        {/* Explanation Box */}
                                        <div className="bg-slate-800/50 rounded-lg p-4 mb-4 text-sm">
                                            <p className="text-slate-300 mb-2"><strong>What are Factor Betas?</strong></p>
                                            <p className="text-slate-400 mb-2">
                                                Factor betas measure how much a stock's returns move with common risk factors,
                                                relative to the broader market. These are computed via regression analysis.
                                            </p>
                                            <ul className="text-slate-400 text-xs space-y-1">
                                                <li><span className="text-cyan-400">Market Œ≤</span>: Sensitivity to overall market returns (vs S&P 500)</li>
                                                <li><span className="text-cyan-400">Value Œ≤</span>: Exposure to value vs growth stocks (high book-to-market vs low)</li>
                                                <li><span className="text-cyan-400">Size Œ≤</span>: Exposure to small-cap vs large-cap stocks</li>
                                                <li><span className="text-cyan-400">Momentum Œ≤</span>: Exposure to recent winners vs losers</li>
                                            </ul>
                                            <p className="text-slate-500 text-xs mt-2">
                                                |t-stat| &gt; 2 indicates statistical significance at 95% confidence level
                                            </p>
                                        </div>

                                        {/* Chart */}
                                        <div className="relative" style={{ height: '280px' }}>
                                            <canvas ref={factorChartRef}></canvas>
                                            {(!results.factors || results.factors.length === 0) && (
                                                <div className="absolute inset-0 flex items-center justify-center text-slate-500 text-sm bg-slate-900/50">
                                                    No factor data available
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* DATA TABLES */}
                                <div className="grid grid-cols-2 gap-6 mb-8">
                                    <DataTable
                                        title="Factor Betas (Detailed)"
                                        data={results.factors || []}
                                        columns={['Factor', 'Beta', 't-stat', 'p-value']}
                                        explanation="Beta = sensitivity coefficient. t-stat = statistical significance (|t| > 2 is significant). p-value = probability this result is random chance."
                                    />
                                    <DataTable
                                        title={`Correlation Anomalies (Top 10 of ${results.anomalies || 0})`}
                                        data={results.anomalies_data || []}
                                        columns={['Date', 'Pair', 'Z-Score']}
                                        explanation={
                                            <span>
                                                <strong>Selection Logic:</strong> Shows top 10 anomalies sorted by |z-score| (most extreme first).
                                                Anomalies are days when the 30-day rolling correlation deviated &gt;2œÉ from historical mean.
                                                <br /><br />
                                                <strong>Universe:</strong> Compared against ~40 assets: SPY, QQQ, TLT, GLD, sector ETFs (XLF, XLE, XLK...), and top S&P 100 stocks.
                                                <br /><br />
                                                <strong>Interpretation:</strong> Z &gt; 2 = unusually high correlation (contagion risk); Z &lt; -2 = correlation breakdown (regime change).
                                            </span>
                                        }
                                    />
                                </div>

                                {/* SABR SECTION */}
                                {results.sabr && (
                                    <div className="mb-8">
                                        <div className="glass p-6 rounded-xl">
                                            <h3 className="text-lg font-semibold text-white mb-2">Options Volatility Smile (SABR Model)</h3>

                                            {/* Explanation */}
                                            <div className="bg-slate-800/50 rounded-lg p-4 mb-4 text-sm">
                                                <div className="bg-amber-900/30 border border-amber-700/50 rounded p-2 mb-3 text-amber-200 text-xs">
                                                    ‚ö†Ô∏è <strong>Note:</strong> This section analyzes <strong>OPTIONS</strong> on the stock, not the stock price itself.
                                                </div>
                                                <p className="text-slate-300 mb-2"><strong>What is the Volatility Smile?</strong></p>
                                                <p className="text-slate-400 mb-2">
                                                    When you look at the prices of options at different strike prices, you'll notice that
                                                    <strong>out-of-the-money puts</strong> (crash protection) are usually <strong>more expensive</strong>
                                                    than at-the-money options. This creates a "smile" shape when plotted.
                                                </p>
                                                <p className="text-slate-400 mb-3">
                                                    <strong>Why it matters:</strong> The SABR model "connects the dots" between these option prices
                                                    to quantify how much "fear" (crash risk) is priced into the market. A steep skew (negative œÅ)
                                                    means investors are paying a premium for downside protection.
                                                    <br /><br />
                                                    <span className="text-slate-500 italic">Note: SABR is also the gold standard for interest rate options (Swaptions, Caps/Floors).</span>
                                                </p>
                                                <div className="grid grid-cols-2 gap-4 text-xs">
                                                    <div>
                                                        <span className="text-sky-400 font-semibold">Œ± (alpha) - The Baseline</span>
                                                        <p className="text-slate-400">The overall level of volatility. Higher = more expensive options across the board.</p>
                                                    </div>
                                                    <div>
                                                        <span className="text-sky-400 font-semibold">Œ≤ (beta) - The Backbone</span>
                                                        <p className="text-slate-400">Controls how volatility changes as the stock price moves. Usually set to 0.5 for equities.</p>
                                                    </div>
                                                    <div>
                                                        <span className="text-sky-400 font-semibold">œÅ (rho) - The Fear Gauge</span>
                                                        <p className="text-slate-400">Negative œÅ means volatility rises when prices fall ‚Äî it's the "fear factor" that makes crash protection expensive.</p>
                                                    </div>
                                                    <div>
                                                        <span className="text-sky-400 font-semibold">ŒΩ (nu) - The Tail Risk</span>
                                                        <p className="text-slate-400">Higher ŒΩ means more "curvy" smile, indicating a higher perceived risk of extreme "black swan" moves.</p>
                                                    </div>
                                                </div>
                                                <p className="text-slate-500 text-xs mt-3">
                                                    <strong>Note:</strong> SABR is calibrated to a single expiry. Parameters vary across expiries (the "volatility surface").
                                                    This tool uses the nearest available expiry.
                                                </p>
                                            </div>

                                            <div className="grid grid-cols-4 gap-4">
                                                <MetricCard
                                                    label="Œ± (alpha)"
                                                    value={typeof results.sabr.alpha === 'number' ? results.sabr.alpha.toFixed(4) : results.sabr.alpha}
                                                    tooltip="ATM volatility level"
                                                />
                                                <MetricCard
                                                    label="Œ≤ (beta)"
                                                    value={typeof results.sabr.beta === 'number' ? results.sabr.beta.toFixed(2) : results.sabr.beta}
                                                    tooltip="CEV backbone exponent (fixed at 0.5 for equity)"
                                                />
                                                <MetricCard
                                                    label="œÅ (rho)"
                                                    value={typeof results.sabr.rho === 'number' ? results.sabr.rho.toFixed(2) : results.sabr.rho}
                                                    tooltip="Spot-vol correlation (negative = downside skew)"
                                                />
                                                <MetricCard
                                                    label="ŒΩ (nu)"
                                                    value={typeof results.sabr.nu === 'number' ? results.sabr.nu.toFixed(4) : results.sabr.nu}
                                                    tooltip="Volatility of volatility (smile curvature)"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        function initApp() {
            try {
                const rootElement = document.getElementById('root');
                if (!rootElement) {
                    console.error('Root element not found');
                    return;
                }

                // Use React 18 createRoot if available, otherwise fallback to ReactDOM.render
                if (ReactDOM.createRoot) {
                    const root = ReactDOM.createRoot(rootElement);
                    root.render(<App />);
                } else if (ReactDOM.render) {
                    // Fallback for older React versions
                    ReactDOM.render(<App />, rootElement);
                } else {
                    console.error('ReactDOM not loaded');
                    rootElement.innerHTML = '<div style="color: white; padding: 20px;">Error: React not loaded. Please check your internet connection.</div>';
                }
            } catch (error) {
                console.error('Error initializing React app:', error);
                const rootElement = document.getElementById('root');
                if (rootElement) {
                    rootElement.innerHTML = `<div style="color: red; padding: 20px;">Error: ${error.message}</div>`;
                }
            }
        }
    </script>
</body>

</html>